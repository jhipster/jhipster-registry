# JHipster registry

This is the [JHipster](http://jhipster.github.io/) registry service, based on [Eureka](https://github.com/Netflix/eureka) and Spring Cloud Config.

## Warning: JHipster 3.0 feature!

This project is to be used with JHipster 3.0, which is not released yet.

If you wish to test this, you need to use our development branch. If you want to do this, don't panic! It's in fact surprisingly easy, just [follow this guide](https://github.com/jhipster/generator-jhipster/blob/master/CONTRIBUTING.md#setup) to setup your environment.

## Architecture

The JHipster microservices architecture is supposed to work in the following way:

- The JHipster Registry is a runtime application, using the usual JHipster structure, on which all applications registers.
- A gateway is a JHipster-generated application (using application type `microservice gateway` when you generate it) that handles Web traffic, and serves an AngularJS application. There can be several different gateways, if needed.
- Microservices are JHipster-generated application (using application type `microservice application` when you generate them), that handle REST requests. They are stateless, and several instances of them can be launched in parallel to handle heavy loads.

## HTTP requests routing using the gateway

When the gateways and the microservices are launched, they will register themselves in the registry (using the `eureka.client.serviceUrl.defaultZone` key in the `src/main/resources/config/application.yml` file.

The gateway will automatically proxy all requests to the microservices, using their application name: for example, when microservices `app1` is registered, it is available on the gateway on the `/app1` URL.

For example, if your gateway is running on `localhost:8080`, you could point to [http://localhost:8080/app1/rest/foos](http://localhost:8080/app1/rest/foos) to
get the `foos` resource served by microservice `app1`. If you're trying to do this with your Web browser, don't forget REST resources are secured by default in JHipster, so you need to send the correct JWT header (see the point on security below), or remove the security on those URLs in the gateway's `SecurityConfiguration` class.

## Application configuration with the JHipster Registry

The JHipster Registry is also a Spring Config Server: when applications are launched they will first connect to the JHipster Registry to get their configuration. This is true for both gateways and microservices.

This configuration is a Spring Boot configuration, like the one found in the JHipster `application-*.yml` files, but it is stored in a central server, so it is easier to manage.

Two kind of configurations are available:

- A `native` configuration, which is used by default in development (using the JHipster `dev` profile), and which uses the local filesystem.
- A `Git` configuration, which is used by default in production (using the JHipster `prod` profile), and which stores the configuration in a Git server. This allows to tag, branch or rollback configurations using the usual Git tools, which are very powerful in this use-case.

As the Gateway routes are configured using Spring Boot, they can also be managed using the Spring Config Server, for example you could map application `app1-v1` to the `/app1` URL in your `v1` branch, and map application `app1-v2` to the `/app1` URL in your `v2` branch. This is a good way of upgrading microservices without any downtime for end-users.

## Security considerations

In a microservices architecture, we use JWT (JSON Web Token) for securing our applications. Tokens are generated by the gateway, and sent to the underlying microservices: as they share a common secret key, microservices are able to validate the token, and authenticate users using that token.

Those tokens are self-sufficient: they have both authentication and authorization information, so microservices do not need to query a database or an external system. This is important in order to ensure a scalable architecture.

For security to work, you need to exchange the JWT secret token between all your applications.

- For each application the default token is unique, and generated by JHipster. It is stored in the `.yo-rc.json` file.
- Tokens are configured with the `jhipster.security.authentication.jwt.secret` key in the `src/main/resources/config/application.yml` file.
- To share this key between all your applications, copy the key from your gateway to all the microservices, or share it using the Spring Config Server.
- A good practice is to have a different key in development and production.

## Running the registry

To run the application, like any JHipster application, just launch:

    mvn

The registry Web console should be available at [http://127.0.0.1:8761/](http://127.0.0.1:8761/).

The microservices will be registered on the gateway, you can see them on the gateway management screen at [http://127.0.0.1:8080/#/gateway](http://127.0.0.1:8080/#/gateway).

## Tips

### Avoid port conflicts

If you run several JHipster microservices on your machine, don't forget to change their default port (8081) by modifying the
`server.port` key in their `src/main/resources/config/application.yml` file, or using the Spring Config Server.

## More information

[JHipster website](http://jhipster.github.io/)
